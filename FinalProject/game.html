<!doctype html>
<html>
    <head>
        <meta charset="UTF-8" />
        <title>Phaser Project 1</title>
        <link rel="stylesheet" type="text/css" href="css/main.css">
        <script src="js/phaser.min.js"></script>
    </head>
    <body>
        <!-- <h1 class="center-text">Destroy the Castle</h1> -->
        <div id="gameArea"></div>
        
        <script type="text/javascript">

            window.onload = function() {
                var MAP_WIDTH = 4000;
                var MAP_HEIGHT = 800;
                var ICON_WIDTH = 80;
                var GRAVITY = 400;
                var game = new Phaser.Game(800, 600, Phaser.AUTO, 'gameArea', { preload: preload, create: create, update: update });
                var objectCollisionGroup;
                var objects;
                var shapeCollisionGroup;
                var shapes;
                var shapeArr;
                var shapeStats;
                var currentLevel;
                var gameState;
                var inputKeys;
                var hud;

                function preload () {
                    game.load.image('ground', 'img/ground.png');
                    game.load.image('trapplatform', 'img/trapplatform.png');
                    game.load.image('keyoff', 'img/keyOff.png');
                    game.load.image('keyon', 'img/keyOn.png');
                    game.load.image('mp1', 'img/movingPlatform.png');
                    game.load.image('doorclosed', 'img/doorclosed.png');
                    game.load.image('dooropen', 'img/dooropen.png');
                    game.load.image('floorbutton', 'img/button.png');
                    game.load.image('blackbox', 'img/Blackbox.png');
                    game.load.image('graybox', 'img/Graybox.png');
                    game.load.image('whitebox', 'img/Whitebox.png');
                    game.load.image('ground', 'img/Ground2.png');
                    game.load.image('square', 'img/Square.png');
                    game.load.image('triangle', 'img/Triangle.png');
                    game.load.image('circle', 'img/Circle.png');
                    game.load.image('rectangle', 'img/Rectangle.png');
                    game.load.image('smallsquare', 'img/SmallSquare.png');
                    game.load.image('bg', 'img/bg.png');
                    game.load.image('activeiconoverlay', 'img/IconOverlay.png');
                    game.load.image('iconbackground', 'img/IconBackground.png');
                    game.load.image('iconborder', 'img/IconBorder.png');
                    game.load.physics('physics', 'json/Hitboxes.json');
                }

                function create () {
                    game.stage.backgroundColor = "#555555";
                    game.world.setBounds(0, 0, MAP_WIDTH, MAP_HEIGHT);
                    
                    game.physics.startSystem(Phaser.Physics.P2JS);
                    
                    game.physics.p2.setImpactEvents(true);
                    
                    game.physics.p2.gravity.y = GRAVITY;
                    
                    objectCollisionGroup = game.physics.p2.createCollisionGroup();
                    shapeCollisionGroup = game.physics.p2.createCollisionGroup();
                    game.physics.p2.updateBoundsCollisionGroup();
                    
                    
                    
                    //Initialize background
                    var background = game.add.sprite(0, 0, 'bg');
                    background.width = game.width;
                    background.height = game.height;
                    background.fixedToCamera = true;
                    
                    //Remove later. Used to display various art assets.
                    //var fbutton = game.add.sprite(MAP_WIDTH/2 - 380, 480, 'doorclosed');
                    //var fbutton = game.add.sprite(MAP_WIDTH/2 - 320, 480, 'dooropen');
                    //var fbutton = game.add.sprite(MAP_WIDTH/2- 180, 540, 'keyoff');
                    //var fbutton = game.add.sprite(MAP_WIDTH/2 - 140, 540, 'keyon');
                    //var fbutton = game.add.sprite(MAP_WIDTH/2 - 240, 550, 'floorbutton');
                    //Adds moving platform
                    //var movingplatform = game.add.sprite(MAP_WIDTH/2, 400, 'trapplatform');
                    //game.add.tween(movingplatform.position).to( {y: 500}, 2000, Phaser.Easing.Linear.None, true, 0, 20, true).loop(true);
                     
                    //NOTE: phaser objects can only be in one group at a time!
                    //Initialize shapes container
                    shapes = game.add.group();
                    shapes.enableBody = true;
                    shapes.physicsBodyType = Phaser.Physics.P2JS;
                    shapes.numShapes = 0;
                    shapes.nextShape = 0;
                    shapeArr = new Array();
                    
                    //Initialize shapestats
                    shapeStats = new Object();
                    //Square Stats
                    shapeStats.square = new Object();
                    shapeStats.square.jumpSpeed = 250;
                    shapeStats.square.maxJumpCount = 3;
                    shapeStats.square.moveSpeed = 100;
                    //Triangle Stats
                    shapeStats.triangle = new Object();
                    shapeStats.triangle.jumpSpeed = 250;
                    shapeStats.triangle.maxJumpCount = 3;
                    shapeStats.triangle.moveSpeed = 100;
                    //Circle Stats
                    shapeStats.circle = new Object();
                    shapeStats.circle.jumpSpeed = 250;
                    shapeStats.circle.maxJumpCount = 2;
                    shapeStats.circle.moveSpeed = 100;
                    
                    
                    
                    //Initialize keyboard inputs
                    inputManager = new Object();
                    
                    //Initialize the input mode
                    inputManager.state = "move"
                    inputManager.movingLeft = false;
                    
                    //Initialize specific key inputs
                    inputManager.key_W = game.input.keyboard.addKey(Phaser.Keyboard.W);
                    inputManager.key_W.onDown.add(wPressed, this);
                    inputManager.key_A = game.input.keyboard.addKey(Phaser.Keyboard.A);
                    inputManager.key_A.onDown.add(aPressed, this);
                    inputManager.key_D = game.input.keyboard.addKey(Phaser.Keyboard.D);
                    inputManager.key_D.onDown.add(dPressed, this);
                    inputManager.key_S = game.input.keyboard.addKey(Phaser.Keyboard.S);
                    inputManager.key_S.onDown.add(sPressed, this);
                    inputManager.key_Q = game.input.keyboard.addKey(Phaser.Keyboard.Q);
                    inputManager.key_Q.onDown.add(qPressed, this);
                    inputManager.key_E = game.input.keyboard.addKey(Phaser.Keyboard.E);
                    inputManager.key_E.onDown.add(ePressed, this);
                    inputManager.key_SPACEBAR = game.input.keyboard.addKey(Phaser.Keyboard.SPACEBAR);
                    inputManager.key_SPACEBAR.onDown.add(spacePressed, this);
                    
                    
                    
                    //Initialize the HUD
                    hud = new Object();

                    
                    
                    //Initialize Game State Variable
                    gameState = new Object();
                    gameState.activeShape = null;
                    
                    
                    
                    //Initialize the level
                    currentLevel = 0;
                    loadLevel(currentLevel);
                }
                
                function loadLevel(levelIdx) {
                    //Delete any levels that might exist
                    deleteLevel();
                    
                    objects = game.add.group();
                    objects.enableBody = true;
                    objects.physicsBodyType = Phaser.Physics.P2JS;
                    
                    var ground = spawnObject(MAP_WIDTH / 2, game.height - 10, 'ground', true);
                    
                    ground.body.friction = 1.0;
                    
                    
                    if (levelIdx == 0) {
                        //Load Level 0
                        //Load the terrain blocks
                        
                        //Load the fighters
                        //Make the first fighter be the one that is active first
                        var shape = spawnShape(MAP_WIDTH/2 - 40, game.height - 120, "square");
                        switchShape(shape);
                        shape = spawnShape(MAP_WIDTH/2 + 200, game.height - 120, "circle");
                        shape = spawnShape(MAP_WIDTH/2 + 260, game.height - 120, "triangle");
                        
                    }
                    
                    //Reset the HUD to match the new shapes
                    resetHUD();
                }
                
                function deleteLevel() {
                    if (objects != null) {
                        objects.destroy();
                    }
                }
                
                //Spawns a physics object
                function spawnObject(xPos, yPos, texture, stationary) {
                    var block = objects.create(xPos, yPos, texture);
                    block.body.setCollisionGroup(objectCollisionGroup);
                    block.body.collides(objectCollisionGroup);
                    block.body.collides(shapeCollisionGroup);
                    block.body.kinematic = stationary;
                    
                    return block;
                }
                
                //Spawns a shape
                function spawnShape(xPos, yPos, type) {
                    
                    var tileSheet = getShapeSprite(type);
                    
                    var shape = shapes.create(xPos, yPos, tileSheet);
                    shapeArr.push(shape);
                    shapes.numShapes++;
                    shape.shapeType = type;
                    switch (shape.shapeType) {
                        case ("square"):
                            shape.jumpSpeed = shapeStats.square.jumpSpeed;
                            shape.maxJumpCount = shapeStats.square.maxJumpCount;
                            shape.currJumpCount = shapeStats.square.maxJumpCount;
                            shape.moveSpeed = shapeStats.square.moveSpeed;
                            shape.prevY = 0;
                            //shape.body.fixedRotation = true;
                            break;
                        case ("triangle"):
                            shape.jumpSpeed = shapeStats.triangle.jumpSpeed;
                            shape.moveSpeed = shapeStats.triangle.moveSpeed;
                            shape.maxJumpCount = shapeStats.triangle.maxJumpCount;
                            shape.currJumpCount = shapeStats.triangle.maxJumpCount;
                            shape.prevY = 0;
                            shape.body.clearShapes();
                            shape.body.loadPolygon("physics", "Triangle");
                            break;
                        case ("circle"):
                            shape.jumpSpeed = shapeStats.circle.jumpSpeed;
                            shape.moveSpeed = shapeStats.circle.moveSpeed;
                            shape.maxJumpCount = shapeStats.circle.maxJumpCount;
                            shape.currJumpCount = shapeStats.circle.maxJumpCount;
                            shape.prevY = 0;
                            shape.body.clearShapes();
                            shape.body.loadPolygon("physics", "Circle");
                            break;
                    }
                    shape.body.setCollisionGroup(shapeCollisionGroup);
                    shape.body.collides(shapeCollisionGroup);
                    shape.body.collides(objectCollisionGroup);
                    shape.body.kinematic = true;
                    shape.body.friction = 200.0;
                    
                    return shape;
                    
                }
                
                function update() {
                    updateShapes();
                    
                    processInput();
                    updateHUD();
                }
                
                function processInput() {
                    inputManager.movingLeft = false;
                    
                    //Keyboard input checks
                    if (inputManager.key_W.isDown) {
                        wDown();
                    }
                    if (inputManager.key_A.isDown) {
                        aDown();
                    }
                    if (inputManager.key_S.isDown) {
                        sDown();
                    }
                    if (inputManager.key_D.isDown) {
                        dDown();
                    }
                    if (inputManager.key_SPACEBAR.isDown) {
                        spaceDown();
                    }
                }
                
                function updateHUD() {
                    hud.iconBackgrounds.forEach(function(icon) {
                        game.world.bringToTop(icon);
                    });
                    hud.iconBorders.forEach(function(icon) {
                        game.world.bringToTop(icon);
                    });
                    hud.icons.forEach(function(icon) {
                        game.world.bringToTop(icon);
                    });
                    
                    hud.activeIcon.cameraOffset.x = ICON_WIDTH * shapeArr.indexOf(gameState.activeShape)
                    console.log(hud.activeIcon.cameraOffset.x);
                    game.world.bringToTop(hud.activeIcon);
                    
                }
                
                function resetHUD() {
                    if (hud.iconBackgrounds != null) {
                        hud.iconBackgrounds.destroy();
                    }
                    hud.iconBackgrounds = game.add.group();
                    if (hud.iconBorders != null) {
                        hud.iconBorders.destroy();
                    }
                    hud.iconBorders = game.add.group();
                    if (hud.icons != null) {
                        hud.icons.destroy();
                    }
                    hud.icons = game.add.group();
                    if (hud.activeIcon != null) {
                        hud.activeIcon.destroy();
                    }
                    hud.activeIcon = game.add.sprite(0, game.height - ICON_WIDTH, "activeiconoverlay");
                    hud.activeIcon.fixedToCamera = true;
                    hud.activeIcon.cameraOffset.x = 0;
                    hud.activeIcon.cameraOffset.y = game.height - ICON_WIDTH;
                    
                    shapes.forEach(function(shape) {
                        var index = shapeArr.indexOf(shape);
                        var xPos = (ICON_WIDTH * index) + (ICON_WIDTH / 2) - (shape.width / 2);
                        var yPos = game.height - ((ICON_WIDTH / 2) + (shape.height / 2));
                        var shapeIconSprite = hud.icons.create(xPos, yPos, getShapeSprite(shape.shapeType));
                        
                        shapeIconSprite.fixedToCamera = true;
                        
                        shapeIconSprite.cameraOffset.x = xPos;
                        shapeIconSprite.cameraOffset.y = yPos;
                    });
                    
                    var xPos = 0;
                    var yPos = game.height - ICON_WIDTH;
                    hud.icons.forEach(function(icon) {
                        var sprite = hud.iconBackgrounds.create(xPos, yPos, "iconbackground");
                        sprite.fixedToCamera = true;
                        sprite.cameraOffset.x = xPos;
                        sprite.cameraOffset.y = yPos;
                        sprite = hud.iconBorders.create(xPos, yPos, "iconborder");
                        sprite.fixedToCamera = true;
                        sprite.cameraOffset.x = xPos;
                        sprite.cameraOffset.y = yPos;
                        xPos += ICON_WIDTH;
                    });
                }
                
                function updateShapes() {
                    shapes.forEach(function(shape) {
                        //Slowly stopping the shape
                        shape.body.velocity.x *= 0.9;
                    });
                    
                    //Check for falling off ledge without jumping
                    if (gameState.activeShape.body.velocity.y > 0){
                        if(Math.round(gameState.activeShape.prevY) == 0){
                            if (gameState.activeShape.currJumpCount == gameState.activeShape.maxJumpCount){
                                gameState.activeShape.currJumpCount = gameState.activeShape.maxJumpCount - 1;
                            }
                        }
                    }
                    
                    //Check for jump reset
                    if (Math.round(gameState.activeShape.body.velocity.y) == Math.round(gameState.activeShape.prevY)){
                        gameState.activeShape.currJumpCount = gameState.activeShape.maxJumpCount;
                    }
                    
                    //Updating shape's previous y velocity
                    gameState.activeShape.prevY = gameState.activeShape.body.velocity.y;
                    
                }
                
                function getShapeSprite(type) {
                    var tileSheet;
                    switch (type) {
                        case ("square"):
                            tileSheet = "square";
                            break;
                        case ("triangle"):
                            tileSheet = "triangle";
                            break;
                        case ("circle"):
                            tileSheet = "circle";
                            break;
                        case ("rectangle"):
                            tileSheet = "rectangle";
                            break;
                        case ("smallsquare"):
                            tileSheet = "smallsquare";
                            break;
                    }
                    
                    return tileSheet;
                }
                
                function copyShape(shape) {
                    var xPos = shape.position.x;
                    var yPos = shape.position.y;
                    var type = shape.shapeType;
                    var tilesheet = getShapeSprite(type);
                    var angle = shape.body.angle;
                    
                    var newShape;
                    shapes.remove(shape);
                    newShape = shapes.create(xPos, yPos, tilesheet);
                    shapeArr.splice(shapeArr.indexOf(shape), 1, newShape);
                    shape.destroy();
                    
                    //Initialize the shape's type and its stats
                    newShape.shapeType = type;
                    switch (newShape.shapeType) {
                        case ("square"):
                            newShape.jumpSpeed = shapeStats.square.jumpSpeed;
                            newShape.maxJumpCount = shapeStats.square.maxJumpCount;
                            newShape.currJumpCount = 0;
                            newShape.moveSpeed = shapeStats.square.moveSpeed;
                            newShape.prevY = 0;
                            newShape.body.velocity.y = 1;
                            //newShape.body.fixedRotation = true;
                            break;
                        case ("triangle"):
                            newShape.jumpSpeed = shapeStats.triangle.jumpSpeed;
                            newShape.maxJumpCount = shapeStats.triangle.maxJumpCount;
                            newShape.currJumpCount = 0;
                            newShape.moveSpeed = shapeStats.triangle.moveSpeed;
                            newShape.prevY = 0;
                            newShape.body.velocity.y = 1;
                            newShape.body.clearShapes();
                            newShape.body.loadPolygon("physics", "Triangle");
                            break;
                        case ("circle"):
                            newShape.jumpSpeed = shapeStats.circle.jumpSpeed;
                            newShape.maxJumpCount = shapeStats.circle.maxJumpCount;
                            newShape.currJumpCount = 0;
                            newShape.moveSpeed = shapeStats.circle.moveSpeed;
                            newShape.prevY = 0;
                            newShape.body.velocity.y = 1;
                            newShape.body.clearShapes();
                            newShape.body.loadPolygon("physics", "Circle");
                            break;
                    }
                    newShape.body.setCollisionGroup(shapeCollisionGroup);
                    newShape.body.collides(shapeCollisionGroup);
                    newShape.body.collides(objectCollisionGroup);
                    newShape.body.kinematic = false;
                    newShape.body.friction = 200.0;
                    newShape.body.angle = angle;
                    
                    return newShape;
                    
                    
                }
                
                function switchShape(newShape) {
                    if (gameState.activeShape != null) {
                        console.log("SWITCHING SHAPES");
                        gameState.activeShape.body.velocity.x = 0;
                        gameState.activeShape.body.velocity.y = 0;
                        gameState.activeShape.body.kinematic = true;
                        gameState.activeShape.body.fixedRotation = true;
                        gameState.activeShape = null;
                    }
                    newShape = copyShape(newShape);
                    
                    gameState.activeShape = newShape;
                    game.camera.follow(gameState.activeShape);
                }
                
                function toPrevShape() {
                    shapes.nextShape--;
                    switchShape(shapeArr[shapes.nextShape % shapes.numShapes]);
                }
                
                function toNextShape() {
                    shapes.nextShape++;
                    switchShape(shapeArr[shapes.nextShape % shapes.numShapes]);
                }
                
                
                
                
                
                
                
                
                
                
                function wDown() {
                    console.log("W Down");
                    
                    switch (inputManager.state) {
                        case ("move"):
                            //No Function
                            break;
                    }
                }
                
                function wPressed() {
                    console.log("W Pressed");
                    
                    switch (inputManager.state) {
                        case ("move"):
                            //No Function
                            break;
                    }
                }
                
                function aDown() {
                    console.log("A Down");
                    
                    switch (inputManager.state) {
                        case ("move"):
                            shapeMoveLeft();
                            break;
                    }
                }
                
                function aPressed() {
                    console.log("A Pressed");
                    
                    switch (inputManager.state) {
                        case ("move"):
                            //No Function
                            break;
                    }
                }
                
                function sDown() {
                    console.log("S Down");
                    
                    switch (inputManager.state) {
                        case ("move"):
                            //No Function
                            break;
                    }
                }
                
                function sPressed() {
                    console.log("S Pressed");
                    
                    switch (inputManager.state) {
                        case ("move"):
                            //No Function
                            break;
                    }
                }
                
                function dDown() {
                    console.log("D Down");
                    
                    switch (inputManager.state) {
                        case ("move"):
                            shapeMoveRight();
                            break;
                    }
                }
                
                function dPressed() {
                    console.log("D Pressed");
                    
                    switch (inputManager.state) {
                        case ("move"):
                            //No Function
                            break;
                    }
                }
                
                function qPressed() {
                    console.log("Q Pressed");
                    
                    switch (inputManager.state) {
                        case ("move"):
                            toPrevShape();
                            break;
                    }
                }
                
                function ePressed() {
                    console.log("E Pressed");
                    
                    switch (inputManager.state) {
                        case ("move"):
                            toNextShape();
                            break;
                    }
                }
                
                function spaceDown() {
                    console.log("Space Down");
                    
                    switch (inputManager.state) {
                        case ("move"):
                            //No Function
                            break;
                    }
                }
                
                function spacePressed() {
                    console.log("Space Pressed");
                    
                    switch (inputManager.state) {
                        case ("move"):
                            if (gameState.activeShape.currJumpCount > 0) {
                                shapeJump();
                            }
                            break;
                    }
                }
                
                function shapeJump() {
                    console.log("Shape jumped");
                    
                    if (gameState.activeShape != null) {
                        gameState.activeShape.body.velocity.y = -gameState.activeShape.jumpSpeed;
                    }
                    
                    gameState.activeShape.currJumpCount--;
                }
                
                function shapeMoveLeft() {
                    console.log("Shape moved left");
                    
                    if (gameState.activeShape != null) {
                        gameState.activeShape.body.velocity.x = -1 * gameState.activeShape.moveSpeed;
                        inputManager.movingLeft = true;
                    }
                    
                }
                
                function shapeMoveRight() {
                    console.log("Shape moved right");
                    
                    if (gameState.activeShape != null) {
                        if (!inputManager.movingLeft) {
                            gameState.activeShape.body.velocity.x = gameState.activeShape.moveSpeed;
                        } else {
                            gameState.activeShape.body.velocity.x = 0;
                        }
                    }
                }
            };

        </script>

    </body>
</html>